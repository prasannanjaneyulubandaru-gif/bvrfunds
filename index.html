<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BVR Funds – Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #FE4A03;
      --primary-dark: #E23F00;
      --bg: #ffffff;
      --text-main: #111111;
      --text-muted: #555555;
      --border: #eaeaea;
      --card-bg: #ffffff;
      --chip-bg: #fff5f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
      background: #fafafa;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 20;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 14px;
    }

    .brand-pill {
      width: 24px;
      height: 24px;
      border-radius: 8px;
      background: var(--primary);
    }

    .brand span {
      color: var(--primary);
    }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .layout {
      display: flex;
      width: 100%;
      padding-top: 56px;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      border-right: 1px solid var(--border);
      background: var(--bg);
      padding: 16px 12px;
      position: sticky;
      top: 56px;
      align-self: flex-start;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin: 12px 8px 6px;
    }

    .nav-btn {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 4px;
      border-radius: 10px;
      border: none;
      background: transparent;
      text-align: left;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .nav-btn span.label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .nav-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--border);
    }

    .nav-btn.active {
      background: var(--chip-bg);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .nav-btn.active span.dot {
      background: var(--primary);
    }

    .nav-btn:hover {
      background: #fff1e8;
      color: var(--primary-dark);
    }

    /* Main */
    .main {
      flex: 1;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .top-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      align-items: center;
    }

    .input-inline {
      display: flex;
      flex-direction: column;
      font-size: 11px;
      color: var(--text-muted);
      gap: 3px;
    }

    .input-inline input {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      min-width: 260px;
    }

    .status-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot-ok {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #08c26b;
    }

    .status-dot-bad {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #ff4d4f;
    }

    .btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.8fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .cards-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .main {
        padding: 16px;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #fff0e8;
      color: var(--primary-dark);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    @media (max-width: 700px) {
      .form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    textarea {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 12px;
      resize: vertical;
      min-height: 80px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    .section-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .section-output {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px dashed var(--border);
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
    }

    .logs-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
      max-height: 220px;
      overflow: auto;
      font-size: 11px;
    }

    .logs-list li {
      padding: 4px 0;
      border-bottom: 1px dashed #eee;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .flex-row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--text-muted);
      font-size: 11px;
    }

    .danger-text {
      color: #d93025;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-pill"></div>
        <span>BVR Funds</span>
      </div>
      <div class="flex-row">
        <span id="sessionStatus" class="status-chip">
          <span class="status-dot-bad"></span> No session
        </span>
        <span id="userLabel" class="tag">Not connected</span>
      </div>
    </header>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-section-title">Core</div>
        <button class="nav-btn active" data-section="session">
          <span class="label">
            <span class="dot"></span> Session & Backend
          </span>
        </button>
        <button class="nav-btn" data-section="account">
          <span class="label">
            <span class="dot"></span> Account Snapshot
          </span>
        </button>

        <div class="sidebar-section-title">Signals & Tools</div>
        <button class="nav-btn" data-section="candle">
          <span class="label">
            <span class="dot"></span> Candle Alert
          </span>
        </button>
        <button class="nav-btn" data-section="monitor">
          <span class="label">
            <span class="dot"></span> Background Monitor
          </span>
        </button>
        <button class="nav-btn" data-section="trailing">
          <span class="label">
            <span class="dot"></span> Trailing Status
          </span>
        </button>

        <div class="sidebar-section-title">Strategies</div>
        <button class="nav-btn" data-section="spreads">
          <span class="label">
            <span class="dot"></span> Bull/Bear Spreads
          </span>
        </button>

        <div class="sidebar-section-title">Utilities</div>
        <button class="nav-btn" data-section="utils">
          <span class="label">
            <span class="dot"></span> Email & Logout
          </span>
        </button>
      </aside>

      <!-- Main content -->
      <main class="main">
        <!-- Top row: backend URL + quick actions -->
        <div class="top-row">
          <div class="input-inline">
            <span>Backend URL</span>
            <input
              type="text"
              id="https://bvrfunds-backend.onrender.com"
              placeholder="http://localhost:5000"
            />
          </div>
          <button class="btn btn-ghost btn-sm" id="healthCheckBtn">
            Ping /health
          </button>
          <span class="muted">
            Works with GitHub Pages + Render / local Flask
          </span>
        </div>

        <!-- SECTION: Session & Backend -->
        <section id="section-session" class="section">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Generate Kite Session</div>
                  <div class="card-subtitle">
                    Use request_token from Zerodha login redirect
                  </div>
                </div>
                <span class="pill">Step 1</span>
              </div>

              <div class="form-grid">
                <div>
                  <label>API Key</label>
                  <input type="text" id="apiKey" />
                </div>
                <div>
                  <label>API Secret</label>
                  <input type="text" id="apiSecret" />
                </div>
                <div>
                  <label>Request Token</label>
                  <input type="text" id="requestToken" />
                </div>
                <div class="muted">
                  Paste the token from the Kite redirect URL after login.
                </div>
              </div>

              <div class="section-actions">
                <button class="btn btn-primary" id="generateSessionBtn">
                  Generate Session
                </button>
              </div>

              <div id="sessionOutput" class="section-output">
                Session output will appear here…
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Quick Account Snapshot</div>
                  <div class="card-subtitle">
                    Profile + Margins once you’re connected
                  </div>
                </div>
                <span class="pill">Step 2</span>
              </div>

              <div class="section-actions">
                <button class="btn btn-ghost btn-sm" id="loadProfileBtn">
                  Load Profile
                </button>
                <button class="btn btn-ghost btn-sm" id="loadMarginsBtn">
                  Load Margins
                </button>
              </div>

              <div id="quickSnapshotOutput" class="section-output">
                Waiting for session…
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: Account Snapshot -->
        <section id="section-account" class="section" style="display: none">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Positions</div>
                  <div class="card-subtitle">
                    Live open positions from /api/positions
                  </div>
                </div>
                <button class="btn btn-ghost btn-sm" id="refreshPositionsBtn">
                  Refresh
                </button>
              </div>
              <div id="positionsOutput" class="section-output">
                No data yet.
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Holdings & Orders</div>
                  <div class="card-subtitle">
                    /api/holdings and /api/orders
                  </div>
                </div>
                <div class="flex-row">
                  <button class="btn btn-ghost btn-sm" id="refreshHoldingsBtn">
                    Holdings
                  </button>
                  <button class="btn btn-ghost btn-sm" id="refreshOrdersBtn">
                    Orders
                  </button>
                </div>
              </div>
              <div id="holdingsOrdersOutput" class="section-output">
                No data yet.
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: Candle Alert -->
        <section id="section-candle" class="section" style="display: none">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Check Candle Strength</div>
                  <div class="card-subtitle">
                    Single call to /api/check-candle
                  </div>
                </div>
                <span class="pill">Signal</span>
              </div>

              <div class="form-grid">
                <div>
                  <label>Instrument Token</label>
                  <input
                    type="number"
                    id="candleInstrument"
                    value="256265"
                  />
                </div>
                <div>
                  <label>Interval</label>
                  <select id="candleInterval">
                    <option value="15minute">15minute</option>
                    <option value="5minute">5minute</option>
                    <option value="30minute">30minute</option>
                    <option value="60minute">60minute</option>
                    <option value="day">day</option>
                  </select>
                </div>
                <div>
                  <label>Body % Threshold</label>
                  <input type="number" id="candleThreshold" value="75" />
                </div>
                <div class="muted">
                  Email alert will be sent if body% ≥ threshold.
                </div>
              </div>

              <div class="section-actions">
                <button class="btn btn-primary" id="checkCandleBtn">
                  Run Candle Check
                </button>
              </div>

              <div id="candleOutput" class="section-output">
                Result will appear here…
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: Monitor -->
        <section id="section-monitor" class="section" style="display: none">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Background Candle Monitor</div>
                  <div class="card-subtitle">
                    /api/start-monitor & /api/stop-monitor
                  </div>
                </div>
                <span class="pill">Daemon</span>
              </div>

              <div class="form-grid">
                <div>
                  <label>Instrument Token</label>
                  <input
                    type="number"
                    id="monitorInstrument"
                    value="256265"
                  />
                </div>
                <div>
                  <label>Interval</label>
                  <select id="monitorInterval">
                    <option value="15minute">15minute</option>
                    <option value="5minute">5minute</option>
                    <option value="30minute">30minute</option>
                    <option value="60minute">60minute</option>
                    <option value="day">day</option>
                  </select>
                </div>
                <div>
                  <label>Body % Threshold</label>
                  <input type="number" id="monitorThreshold" value="75" />
                </div>
                <div>
                  <label>Frequency (seconds)</label>
                  <input type="number" id="monitorFrequency" value="300" />
                </div>
              </div>

              <div class="section-actions">
                <button class="btn btn-primary" id="startMonitorBtn">
                  Start Monitor
                </button>
                <button class="btn btn-ghost" id="stopMonitorBtn">
                  Stop Monitor
                </button>
              </div>

              <div id="monitorOutput" class="section-output">
                Monitor status will appear here…
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: Trailing Status -->
        <section id="section-trailing" class="section" style="display: none">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Trailing Positions</div>
                  <div class="card-subtitle">
                    Live view from /api/get-trail-status
                  </div>
                </div>
                <button class="btn btn-ghost btn-sm" id="refreshTrailBtn">
                  Refresh
                </button>
              </div>

              <div id="trailingPositionsOutput" class="section-output">
                No trailing positions yet.
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Trailing Logs</div>
                  <div class="card-subtitle">
                    Last 20 log entries for your user_id
                  </div>
                </div>
                <span class="badge">Read-only</span>
              </div>
              <ul id="trailingLogsList" class="logs-list">
                <!-- logs -->
              </ul>
            </div>
          </div>
        </section>

        <!-- SECTION: Spreads -->
        <section id="section-spreads" class="section" style="display: none">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Bull Spread Helper</div>
                  <div class="card-subtitle">
                    /api/get-bull-spread (Mock NFO logic in backend)
                  </div>
                </div>
                <span class="pill">Bullish</span>
              </div>

              <div class="form-grid">
                <div>
                  <label>Lower Premium</label>
                  <input type="number" id="bullLower" value="0" />
                </div>
                <div>
                  <label>Upper Premium</label>
                  <input type="number" id="bullUpper" value="100" />
                </div>
              </div>

              <div class="section-actions">
                <button class="btn btn-primary" id="getBullSpreadBtn">
                  Get Bull Spread
                </button>
              </div>
              <div id="bullSpreadOutput" class="section-output">
                Result will appear here…
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Bear Spread Helper</div>
                  <div class="card-subtitle">
                    /api/get-bear-spread
                  </div>
                </div>
                <span class="pill">Bearish</span>
              </div>

              <div class="form-grid">
                <div>
                  <label>Lower Premium</label>
                  <input type="number" id="bearLower" value="0" />
                </div>
                <div>
                  <label>Upper Premium</label>
                  <input type="number" id="bearUpper" value="100" />
                </div>
              </div>

              <div class="section-actions">
                <button class="btn btn-primary" id="getBearSpreadBtn">
                  Get Bear Spread
                </button>
              </div>
              <div id="bearSpreadOutput" class="section-output">
                Result will appear here…
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: Utils -->
        <section id="section-utils" class="section" style="display: none">
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Test Email Alert</div>
                  <div class="card-subtitle">
                    /api/test-email using your Gmail app password
                  </div>
                </div>
                <span class="pill">Mail</span>
              </div>

              <div class="section-actions">
                <button class="btn btn-primary" id="testEmailBtn">
                  Send Test Email
                </button>
              </div>

              <div id="testEmailOutput" class="section-output">
                Output will appear here…
              </div>

              <p class="muted" style="margin-top: 8px;">
                <span class="danger-text">Security tip:</span> avoid hardcoding
                Gmail passwords in public repos; use environment variables
                or secrets on your server.
              </p>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Logout</div>
                  <div class="card-subtitle">
                    /api/logout & clear local state
                  </div>
                </div>
                <span class="pill">Session</span>
              </div>

              <div class="section-actions">
                <button class="btn btn-ghost" id="logoutBtn">
                  Logout
                </button>
              </div>

              <div id="logoutOutput" class="section-output">
                Not logged out yet.
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // === State ===
    let backendBase = "";
    let userId = null;

    function getBackendBase() {
      const inputVal = document.getElementById("backendUrl").value.trim();
      if (inputVal) backendBase = inputVal.replace(/\/+$/, "");
      if (!backendBase) backendBase = "http://localhost:5000";
      return backendBase;
    }

    function getHeaders() {
      const headers = { "Content-Type": "application/json" };
      if (userId) headers["X-User-ID"] = userId;
      return headers;
    }

    function setSessionStatus(ok, text, userLabel) {
      const chip = document.getElementById("sessionStatus");
      const label = document.getElementById("userLabel");
      chip.innerHTML = ok
        ? '<span class="status-dot-ok"></span> Session active'
        : '<span class="status-dot-bad"></span> No session';
      label.textContent = userLabel || (ok ? "Connected" : "Not connected");
    }

    function pretty(obj) {
      return JSON.stringify(obj, null, 2);
    }

    // === Navigation ===
    const navButtons = document.querySelectorAll(".nav-btn");
    const sections = document.querySelectorAll("section.section");
    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        navButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const target = btn.getAttribute("data-section");
        sections.forEach((s) => {
          s.style.display =
            s.id === "section-" + target ? "block" : "none";
        });
      });
    });

    // === Backend Health ===
    document
      .getElementById("healthCheckBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        try {
          const res = await fetch(base + "/health");
          const data = await res.json();
          setSessionStatus(true, "Backend OK", "Backend ✓");
          alert("Health check OK: " + JSON.stringify(data));
        } catch (e) {
          setSessionStatus(false);
          alert("Health check failed: " + e);
        }
      });

    // === Generate Session ===
    document
      .getElementById("generateSessionBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const apiKey = document.getElementById("apiKey").value.trim();
        const apiSecret = document.getElementById("apiSecret").value.trim();
        const requestToken = document
          .getElementById("requestToken")
          .value.trim();
        const out = document.getElementById("sessionOutput");

        out.textContent = "Generating session…";

        try {
          const res = await fetch(base + "/api/generate-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ api_key: apiKey, api_secret: apiSecret, request_token: requestToken })
          });
          const data = await res.json();
          out.textContent = pretty(data);

          if (data.success && data.user_id) {
            userId = data.user_id;
            setSessionStatus(true, "Session OK", data.user_name || data.email || data.user_id);
          } else {
            setSessionStatus(false);
          }
        } catch (e) {
          out.textContent = "Error: " + e;
          setSessionStatus(false);
        }
      });

    // === Quick Profile & Margins ===
    document
      .getElementById("loadProfileBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("quickSnapshotOutput");
        out.textContent = "Loading profile…";
        try {
          const res = await fetch(base + "/api/profile", {
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    document
      .getElementById("loadMarginsBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("quickSnapshotOutput");
        out.textContent = "Loading margins…";
        try {
          const res = await fetch(base + "/api/margins", {
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    // === Account Snapshot ===
    document
      .getElementById("refreshPositionsBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("positionsOutput");
        out.textContent = "Loading positions…";
        try {
          const res = await fetch(base + "/api/positions", {
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    document
      .getElementById("refreshHoldingsBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("holdingsOrdersOutput");
        out.textContent = "Loading holdings…";
        try {
          const res = await fetch(base + "/api/holdings", {
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = "HOLDINGS:\n" + pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    document
      .getElementById("refreshOrdersBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("holdingsOrdersOutput");
        out.textContent = "Loading orders…";
        try {
          const res = await fetch(base + "/api/orders", {
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = "ORDERS:\n" + pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    // === Candle Check ===
    document
      .getElementById("checkCandleBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("candleOutput");
        const instrument = Number(
          document.getElementById("candleInstrument").value
        );
        const interval = document.getElementById("candleInterval").value;
        const threshold = Number(
          document.getElementById("candleThreshold").value
        );
        out.textContent = "Checking candle…";

        try {
          const res = await fetch(base + "/api/check-candle", {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({
              instrument_token: instrument,
              interval,
              threshold,
            }),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    // === Monitor ===
    document
      .getElementById("startMonitorBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("monitorOutput");
        const instrument = Number(
          document.getElementById("monitorInstrument").value
        );
        const interval = document.getElementById("monitorInterval").value;
        const threshold = Number(
          document.getElementById("monitorThreshold").value
        );
        const frequency = Number(
          document.getElementById("monitorFrequency").value
        );

        out.textContent = "Starting monitor…";

        try {
          const res = await fetch(base + "/api/start-monitor", {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({
              instrument_token: instrument,
              interval,
              threshold,
              frequency,
            }),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    document
      .getElementById("stopMonitorBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("monitorOutput");
        out.textContent = "Stopping monitor…";
        try {
          const res = await fetch(base + "/api/stop-monitor", {
            method: "POST",
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    // === Trailing Status ===
    document
      .getElementById("refreshTrailBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const posOut = document.getElementById("trailingPositionsOutput");
        const logsUl = document.getElementById("trailingLogsList");

        posOut.textContent = "Loading trailing status…";
        logsUl.innerHTML = "";

        try {
          const res = await fetch(base + "/api/get-trail-status", {
            headers: getHeaders(),
          });
          const data = await res.json();

          if (!data.success) {
            posOut.textContent = pretty(data);
            return;
          }

          posOut.textContent = pretty(data.positions || {});

          const logs = data.logs || [];
          logs.forEach((entry) => {
            const li = document.createElement("li");
            const t = new Date(entry.time * 1000);
            li.textContent =
              "[" +
              t.toLocaleTimeString() +
              "] " +
              (entry.msg || JSON.stringify(entry));
            logsUl.appendChild(li);
          });
        } catch (e) {
          posOut.textContent = "Error: " + e;
        }
      });

    // === Spreads ===
    document
      .getElementById("getBullSpreadBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("bullSpreadOutput");
        const lower = Number(document.getElementById("bullLower").value);
        const upper = Number(document.getElementById("bullUpper").value);
        out.textContent = "Requesting bull spread…";

        try {
          const res = await fetch(base + "/api/get-bull-spread", {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({
              lower_premium: lower,
              upper_premium: upper,
            }),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    document
      .getElementById("getBearSpreadBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("bearSpreadOutput");
        const lower = Number(document.getElementById("bearLower").value);
        const upper = Number(document.getElementById("bearUpper").value);
        out.textContent = "Requesting bear spread…";

        try {
          const res = await fetch(base + "/api/get-bear-spread", {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({
              lower_premium: lower,
              upper_premium: upper,
            }),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    // === Test Email ===
    document
      .getElementById("testEmailBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("testEmailOutput");
        out.textContent = "Sending test email…";

        try {
          const res = await fetch(base + "/api/test-email", {
            method: "POST",
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = pretty(data);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });

    // === Logout ===
    document
      .getElementById("logoutBtn")
      .addEventListener("click", async () => {
        const base = getBackendBase();
        const out = document.getElementById("logoutOutput");
        out.textContent = "Logging out…";
        try {
          const res = await fetch(base + "/api/logout", {
            method: "POST",
            headers: getHeaders(),
          });
          const data = await res.json();
          out.textContent = pretty(data);
          userId = null;
          setSessionStatus(false);
        } catch (e) {
          out.textContent = "Error: " + e;
        }
      });
  </script>
</body>
</html>
